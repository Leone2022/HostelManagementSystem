@model HostelMS.ViewModels.BookingProcessViewModel
@{
    ViewData["Title"] = "Process Booking";
}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-10 mx-auto">
            <div class="card shadow">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i> Review Booking #@Model.BookingId</h5>
                    <span class="badge bg-warning text-dark">Pending Approval</span>
                </div>
                <div class="card-body">
                    @if (Model.Booking == null)
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Booking information not found.
                        </div>
                    }
                    else
                    {
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-lg-8">
                                <!-- Booking Details Card -->
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i> Booking Details</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <dl class="row mb-0">
                                                    <dt class="col-sm-4">Booking ID:</dt>
                                                    <dd class="col-sm-8">#@Model.Booking.BookingId</dd>
                                                    
                                                    <dt class="col-sm-4">Date:</dt>
                                                    <dd class="col-sm-8">@Model.Booking.BookingDate.ToString("dd MMM yyyy HH:mm")</dd>
                                                    
                                                    <dt class="col-sm-4">Check-in:</dt>
                                                    <dd class="col-sm-8">@Model.Booking.CheckInDate.ToString("dd MMM yyyy")</dd>
                                                    
                                                    <dt class="col-sm-4">Check-out:</dt>
                                                    <dd class="col-sm-8">@Model.Booking.CheckOutDate.ToString("dd MMM yyyy")</dd>
                                                </dl>
                                            </div>
                                            <div class="col-md-6">
                                                <dl class="row mb-0">
                                                    <dt class="col-sm-4">Status:</dt>
                                                    <dd class="col-sm-8">
                                                        <span class="badge bg-warning text-dark">Pending</span>
                                                    </dd>
                                                    
                                                    <dt class="col-sm-4">Amount:</dt>
                                                    <dd class="col-sm-8">UGX @Model.Booking.TotalAmount.ToString("N0")</dd>
                                                    
                                                    <dt class="col-sm-4">Hostel:</dt>
                                                    <dd class="col-sm-8">@Model.Booking.Room?.Hostel?.Name</dd>
                                                    
                                                    <dt class="col-sm-4">Room:</dt>
                                                    <dd class="col-sm-8">@Model.Booking.Room?.RoomNumber</dd>
                                                </dl>
                                            </div>
                                        </div>
                                        
                                        @if (!string.IsNullOrEmpty(Model.Booking.Comments))
                                        {
                                            <div class="mt-3">
                                                <h6 class="fw-bold">Comments:</h6>
                                                <p class="mb-0">@Model.Booking.Comments</p>
                                            </div>
                                        }
                                    </div>
                                </div>
                                
                                <!-- Student Information Card -->
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-user-graduate me-2"></i> Student Information</h6>
                                    </div>
                                    <div class="card-body">
                                        @if (Model.Booking.Student != null)
                                        {
                                            <div class="row">
                                                <div class="col-md-2 text-center">
                                                    @if (!string.IsNullOrEmpty(Model.Booking.Student.ProfilePicture))
                                                    {
                                                        <img src="@Model.Booking.Student.ProfilePicture" class="rounded-circle img-thumbnail mb-2" 
                                                             style="width:80px; height:80px; object-fit: cover;" alt="Profile Picture">
                                                    }
                                                    else
                                                    {
                                                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center mx-auto mb-2" 
                                                             style="width:80px; height:80px;">
                                                            <i class="fas fa-user fa-2x"></i>
                                                        </div>
                                                    }
                                                </div>
                                                <div class="col-md-5">
                                                    <h5>@Model.Booking.Student.FirstName @Model.Booking.Student.LastName</h5>
                                                    <p class="mb-0 text-muted">Student ID: @Model.Booking.Student.StudentId</p>
                                                    <p class="mb-0 text-muted">Course: @Model.Booking.Student.Course</p>
                                                    <p class="mb-0 text-muted">Year: @Model.Booking.Student.Year</p>
                                                </div>
                                                <div class="col-md-5">
                                                    <p class="mb-0 text-muted"><i class="fas fa-phone me-2"></i>@Model.Booking.Student.PhoneNumber</p>
                                                    <p class="mb-0 text-muted"><i class="fas fa-envelope me-2"></i>@Model.Booking.Student.Email</p>
                                                    <p class="mb-0 text-muted"><i class="fas fa-map-marker-alt me-2"></i>@Model.Booking.Student.Address</p>
                                                    <p class="mb-0 text-muted"><i class="fas fa-flag me-2"></i>@Model.Booking.Student.Nationality</p>
                                                </div>
                                            </div>
                                            
                                            <div class="mt-3">
                                                <a asp-controller="Student" asp-action="Details" asp-route-id="@Model.Booking.Student.Id" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-user-circle me-1"></i> View Full Student Profile
                                                </a>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                Student information not available.
                                            </div>
                                        }
                                    </div>
                                </div>
                                
                                <!-- Payment Information Card -->
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0"><i class="fas fa-money-bill-wave me-2"></i> Payment Information</h6>
                                    </div>
                                    <div class="card-body">
                                        @if (Model.Payment != null)
                                        {
                                            <div class="row mb-3">
                                                <div class="col-md-6">
                                                    <dl class="row mb-0">
                                                        <dt class="col-sm-4">Amount:</dt>
                                                        <dd class="col-sm-8">UGX @Model.Payment.Amount.ToString("N0")</dd>
                                                        
                                                        <dt class="col-sm-4">Date:</dt>
                                                        <dd class="col-sm-8">@Model.Payment.PaymentDate.ToString("dd MMM yyyy HH:mm")</dd>
                                                        
                                                        <dt class="col-sm-4">Method:</dt>
                                                        <dd class="col-sm-8">@Model.Payment.Method.ToString()</dd>
                                                    </dl>
                                                </div>
                                                <div class="col-md-6">
                                                    <dl class="row mb-0">
                                                        <dt class="col-sm-4">Status:</dt>
                                                        <dd class="col-sm-8">
                                                            <span class="badge bg-warning text-dark">@Model.Payment.Status.ToString()</span>
                                                        </dd>
                                                        
                                                        <dt class="col-sm-4">Reference:</dt>
                                                        <dd class="col-sm-8">@Model.Payment.TransactionReference</dd>
                                                        
                                                        @if (!string.IsNullOrEmpty(Model.Payment.Notes))
                                                        {
                                                            <dt class="col-sm-4">Notes:</dt>
                                                            <dd class="col-sm-8">@Model.Payment.Notes</dd>
                                                        }
                                                    </dl>
                                                </div>
                                            </div>
                                            
                                            @if (!string.IsNullOrEmpty(Model.Payment.ProofOfPaymentUrl))
                                            {
                                                <h6 class="fw-bold mb-2">Payment Proof:</h6>
                                                <div class="payment-proof-container text-center">
                                                    @if (Model.Payment.ProofOfPaymentUrl.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
                                                    {
                                                        <div class="mb-2">
                                                            <a href="@Model.Payment.ProofOfPaymentUrl" class="btn btn-sm btn-primary" target="_blank">
                                                                <i class="fas fa-file-pdf me-1"></i> View PDF Payment Proof
                                                            </a>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <img src="@Model.Payment.ProofOfPaymentUrl" class="img-fluid rounded border shadow-sm" 
                                                             style="max-height: 250px;" alt="Payment Proof">
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="alert alert-warning">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    No payment proof uploaded.
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle me-2"></i>
                                                Payment information not available.
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column - Decision Area -->
                            <div class="col-lg-4">
                                <!-- Decision Form Card -->
                                <div class="card shadow-sm mb-4 sticky-top" style="top: 20px; z-index: 100;">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i> Process Booking</h6>
                                    </div>
                                    <div class="card-body">
                                        <form asp-action="ProcessBooking" method="post">
                                            <input type="hidden" asp-for="BookingId" />
                                            
                                            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-3"></div>
                                            
                                            <!-- Room Availability Alert -->
                                            @if (Model.Booking.Room != null)
                                            {
                                                var room = Model.Booking.Room;
                                                var remainingCapacity = room.Capacity - room.CurrentOccupancy;
                                                
                                                @if (remainingCapacity <= 0)
                                                {
                                                    <div class="alert alert-danger mb-3">
                                                        <i class="fas fa-exclamation-circle me-2"></i>
                                                        <strong>Warning:</strong> This room is already fully occupied. Approving this booking will result in overbooking.
                                                    </div>
                                                }
                                                else if (remainingCapacity < 2)
                                                {
                                                    <div class="alert alert-warning mb-3">
                                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                                        <strong>Note:</strong> This room has only @remainingCapacity bed(s) available.
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="alert alert-success mb-3">
                                                        <i class="fas fa-check-circle me-2"></i>
                                                        <strong>Room Available:</strong> This room has @remainingCapacity beds available.
                                                    </div>
                                                }
                                            }
                                            
                                            <div class="mb-4">
                                                <label class="form-label fw-bold">Decision</label>
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="radio" name="IsApproved" id="approveBooking" value="true" checked>
                                                    <label class="form-check-label" for="approveBooking">
                                                        <span class="text-success fw-bold">Approve</span> - 
                                                        Accept payment and confirm the booking
                                                    </label>
                                                </div>
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="IsApproved" id="rejectBooking" value="false">
                                                    <label class="form-check-label" for="rejectBooking">
                                                        <span class="text-danger fw-bold">Reject</span> - 
                                                        Decline the booking request
                                                    </label>
                                                </div>
                                            </div>
                                            
                                            <div class="mb-4" id="rejectionReasonGroup" style="display:none;">
                                                <label asp-for="RejectionReason" class="form-label fw-bold">Rejection Reason</label>
                                                <textarea asp-for="RejectionReason" class="form-control" rows="3" 
                                                          placeholder="Please provide a reason for rejecting this booking request..."></textarea>
                                                <span asp-validation-for="RejectionReason" class="text-danger"></span>
                                                <div class="form-text">This reason will be displayed to the student.</div>
                                            </div>
                                            
                                            <div class="d-grid gap-2 mt-4">
                                                <button type="submit" class="btn btn-primary btn-lg">
                                                    <i class="fas fa-save me-2"></i> Submit Decision
                                                </button>
                                                <a asp-action="ManageBookings" class="btn btn-outline-secondary">
                                                    <i class="fas fa-arrow-left me-2"></i> Back to Bookings
                                                </a>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            // Toggle rejection reason field based on decision
            $('input[name="IsApproved"]').change(function() {
                if ($(this).val() === 'false') {
                    $('#rejectionReasonGroup').slideDown();
                    $('#RejectionReason').attr('required', 'required');
                } else {
                    $('#rejectionReasonGroup').slideUp();
                    $('#RejectionReason').removeAttr('required');
                }
            });
            
            // Trigger change on load to set initial state
            $('input[name="IsApproved"]:checked').trigger('change');
            
            // Confirm submission
            $('form').submit(function(e) {
                var isApproved = $('input[name="IsApproved"]:checked').val() === 'true';
                var message = isApproved ? 
                    'Are you sure you want to APPROVE this booking? The student will be notified and the room will be allocated.' : 
                    'Are you sure you want to REJECT this booking? The student will be notified of your decision.';
                
                if (!confirm(message)) {
                    e.preventDefault();
                    return false;
                }
                return true;
            });
        });
    </script>
}